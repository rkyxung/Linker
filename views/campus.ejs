<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linker</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/board.css" />
</head>

<body class="page-campus">
  <% const displayName=currentUser && currentUser.nickname ? currentUser.nickname : currentUser && currentUser.name ?
    currentUser.name : "링커" ; %>

    <%- include('include/_nav', { active: 'campus', displayName: displayName }) %>

      <main class="main-content" aria-label="메인 콘텐츠">
        <section class="hero-card">
          <div class="hero-text">
            <h1 class="hero-nickname">
              <span>아이디어 구현부터 팀원 매칭까지</span>
            </h1>
            <p class="hero-job">
              Linker는 여러분의 프로젝트 성공을 응원합니다<br>
              여러분을 도와 줄 인재가 기다리고 있습니다
            </p>
            <div class="hero-cta-container">
              <a href="/campus/add" class="hero-cta-btn">
                팀원 모집하기
              </a>
              <a href="/campus/seek" class="hero-cta-btn">
                팀 구하기
              </a>
            </div>
          </div>
          <div class="hero-decoration">
            <div class="line-top"></div>
            <div class="dots-top"></div>
            <div class="circleBig-bottom"></div>
          </div>
        </section>

        <section class="my-board" aria-label="게시판">
          <div class="board-tabs-container">
            <div class="board-tabs" role="tablist" aria-label="활동 유형">
              <button class="tab-btn is-active" type="button" role="tab" id="tab-latest" aria-controls="panel-latest"
                aria-selected="true" data-tab="latest">최신</button>
              <button class="tab-btn" type="button" role="tab" id="tab-popular" aria-controls="panel-popular"
                aria-selected="false" data-tab="popular">인기</button>
            </div>
          </div>

          <div class="board-panels">

            <div class="board-panel is-active" data-panel="latest" role="tabpanel" id="panel-latest"
              aria-labelledby="tab-latest">
              <%
                const latestPosts = typeof posts !== 'undefined' && posts ? posts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)) : [];
              %>
              <% if (latestPosts.length > 0) { %>
                <% latestPosts.forEach(post => { %>
                  <article class="post-card" onclick="window.location.href='<%= post.postType === 'recruit' ? '/campus/' : '/campus/seek/' %><%= post._id %>'">
                    <!-- 상단: 제목 + 스크랩/댓글 -->
                    <div class="post-card-header">
                      <h2 class="post-card-title"><%= post.title %></h2>
                      <div class="post-card-actions" onclick="event.stopPropagation();">
                        <button type="button" class="scrap-btn-preview" data-post-id="<%= post._id %>" data-post-type="<%= post.postType %>" data-is-scrapped="<%= post.isScrapped ? 'true' : 'false' %>">
                          <svg width="14" height="17" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.7139 1C14.0837 1 14.3718 1.1174 14.6318 1.37012C14.891 1.62205 15.0004 1.88812 15 2.2207V18.5L8.38477 15.7432C8.13863 15.6406 7.86137 15.6406 7.61523 15.7432L1 18.5V2.22266C1 1.88855 1.10965 1.6221 1.36816 1.37109C1.59622 1.14975 1.84572 1.03206 2.15234 1.00586L2.28711 1H13.7139Z" stroke="<%= post.isScrapped ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isScrapped ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-scraps-preview-<%= post._id %>"><%= post.scraps || 0 %></span>
                        </button>
                        <div class="post-card-comment">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
</svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <!-- 본문: 내용 -->
                    <div class="post-card-body">
                      <p class="post-card-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                    <!-- 해시태그 -->
                    <% if (post.hashtags && post.hashtags.length > 0) { %>
                      <div class="post-card-hashtags">
                        <% post.hashtags.forEach(tag => { %>
                          <span class="post-card-hashtag">#<%= tag %></span>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="post-card-hashtags-empty"></div>
                    <% } %>
                    <!-- 하단: 글쓴이 + 마감일 -->
                    <div class="post-card-footer">
                      <span><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %></span>
                      <span>마감일: <%= post.postType === 'recruit' && post.deadline ? new Date(post.deadline).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\./g, '.').replace(/\s/g, '') : '-' %></span>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <article class="post-card post-card--empty" aria-live="polite">
                  <div class="post-empty__message">
                    <strong>최신 글이 없습니다</strong>
                    새로운 글을 등록하면 순서대로 보여드릴게요.
                  </div>
                </article>
              <% } %>
            </div>

            <div class="board-panel" data-panel="popular" role="tabpanel" id="panel-popular"
              aria-labelledby="tab-popular" hidden>
              <%
                const popularPosts = typeof posts !== 'undefined' && posts 
                  ? posts
                      .filter(post => (post.scraps || 0) >= 2)
                      .sort((a, b) => {
                        const scrapsDiff = (b.scraps || 0) - (a.scraps || 0);
                        if (scrapsDiff !== 0) return scrapsDiff;
                        return (b.views || 0) - (a.views || 0);
                      })
                  : [];
              %>
              <% if (popularPosts.length > 0) { %>
                <% popularPosts.forEach(post => { %>
                  <article class="post-card" onclick="window.location.href='<%= post.postType === 'recruit' ? '/campus/' : '/campus/seek/' %><%= post._id %>'">
                    <!-- 상단: 제목 + 스크랩/댓글 -->
                    <div class="post-card-header">
                      <h2 class="post-card-title"><%= post.title %></h2>
                      <div class="post-card-actions" onclick="event.stopPropagation();">
                        <button type="button" class="scrap-btn-preview" data-post-id="<%= post._id %>" data-post-type="<%= post.postType %>" data-is-scrapped="<%= post.isScrapped ? 'true' : 'false' %>">
                          <svg width="14" height="17" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.7139 1C14.0837 1 14.3718 1.1174 14.6318 1.37012C14.891 1.62205 15.0004 1.88812 15 2.2207V18.5L8.38477 15.7432C8.13863 15.6406 7.86137 15.6406 7.61523 15.7432L1 18.5V2.22266C1 1.88855 1.10965 1.6221 1.36816 1.37109C1.59622 1.14975 1.84572 1.03206 2.15234 1.00586L2.28711 1H13.7139Z" stroke="<%= post.isScrapped ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isScrapped ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-scraps-preview-<%= post._id %>"><%= post.scraps || 0 %></span>
                        </button>
                        <div class="post-card-comment">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
</svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <!-- 본문: 내용 -->
                    <div class="post-card-body">
                      <p class="post-card-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                    <!-- 해시태그 -->
                    <% if (post.hashtags && post.hashtags.length > 0) { %>
                      <div class="post-card-hashtags">
                        <% post.hashtags.forEach(tag => { %>
                          <span class="post-card-hashtag">#<%= tag %></span>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="post-card-hashtags-empty"></div>
                    <% } %>
                    <!-- 하단: 글쓴이 + 마감일 -->
                    <div class="post-card-footer">
                      <span><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %></span>
                      <span>마감일: <%= post.postType === 'recruit' && post.deadline ? new Date(post.deadline).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\./g, '.').replace(/\s/g, '') : '-' %></span>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <article class="post-card post-card--empty" aria-live="polite">
                  <div class="post-empty__message">
                    <strong>인기 글이 없습니다</strong>
                    인기 글이 준비되면 이곳에 알려드릴게요.
                  </div>
                </article>
              <% } %>
            </div>
          </div>
        </section>

        <p class="main-footer">Linker와 함께 더 많은 협업 기회를 만들어보세요.</p>
      </main>

      <script>
        (function () {
          const tabButtons = document.querySelectorAll(".tab-btn[role='tab']");
          const panels = document.querySelectorAll("[data-panel]");

          tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const target = button.dataset.tab;

              tabButtons.forEach((btn) => {
                const isActive = btn === button;
                btn.classList.toggle("is-active", isActive);
                btn.setAttribute("aria-selected", isActive ? "true" : "false");
              });

              panels.forEach((panel) => {
                const isActive = panel.dataset.panel === target;
                panel.classList.toggle("is-active", isActive);
                panel.hidden = !isActive;
              });
            });
          });

          // 스크랩 기능
          document.querySelectorAll('.scrap-btn-preview').forEach(btn => {
            btn.addEventListener('click', async function(e) {
              e.stopPropagation();
              const postId = this.dataset.postId;
              const postType = this.dataset.postType;
              const scrapsSpan = this.querySelector(`.post-scraps-preview-${postId}`);
              const svg = this.querySelector('svg path');
              
              try {
                const url = postType === 'recruit' 
                  ? `/campus/${postId}/scrap`
                  : `/campus/seek/${postId}/scrap`;
                
                const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (data.success) {
                  scrapsSpan.textContent = data.scraps;
                  if (data.isScrapped) {
                    svg.setAttribute('stroke', '#1D5DFF');
                    svg.setAttribute('fill', '#1D5DFF');
                    svg.removeAttribute('fill-opacity');
                  } else {
                    svg.setAttribute('stroke', '#818181');
                    svg.setAttribute('fill', 'none');
                    svg.removeAttribute('fill-opacity');
                  }
                }
              } catch (error) {
                console.error('스크랩 처리 중 오류:', error);
              }
            });
          });
        })();

        // 폴더 모달 관련
        let folders = <%- JSON.stringify(typeof folders !== 'undefined' && folders ? folders : []) %>;
        let currentScrapPostId = null;
        let currentScrapPostType = null;

        function updateFolderList() {
          const folderList = document.getElementById('folder-list');
          if (folders && folders.length > 0) {
            folderList.innerHTML = folders.map(folder => `
              <button type="button" class="folder-select-item" data-folder-id="${folder._id}">
                <span>${folder.name}</span>
                <span class="folder-select-count">${folder.posts ? folder.posts.length : 0}개</span>
              </button>
            `).join('');
            
            // 폴더 선택 이벤트 리스너 추가
            document.querySelectorAll('.folder-select-item').forEach(btn => {
              btn.addEventListener('click', async function() {
                const folderId = this.dataset.folderId;
                
                try {
                  const response = await fetch(`/folders/${folderId}/posts`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                      postId: currentScrapPostId,
                      postType: currentScrapPostType
                    })
                  });

                  const data = await response.json();
                  if (data.success) {
                    // 폴더 목록 업데이트
                    const folderIndex = folders.findIndex(f => f._id === folderId);
                    if (folderIndex !== -1) {
                      folders[folderIndex] = data.folder;
                      updateFolderList();
                    }
                    
                    document.getElementById('folder-select-modal').close();
                    alert('폴더에 추가되었습니다.');
                  } else {
                    alert(data.message || '폴더에 추가하는데 실패했습니다.');
                  }
                } catch (error) {
                  console.error('폴더에 추가 중 오류:', error);
                  alert('폴더에 추가 중 오류가 발생했습니다.');
                }
              });
            });
          } else {
            folderList.innerHTML = '<p class="folder-empty-message">폴더가 없습니다. 프로필에서 폴더를 먼저 생성해주세요.</p>';
          }
        }

        function showFolderSelectModal() {
          const modal = document.getElementById('folder-select-modal');
          if (modal) {
            updateFolderList();
            modal.showModal();
          }
        }

        function showCreateFolderModal() {
          const modal = document.getElementById('create-folder-modal');
          if (modal) {
            modal.showModal();
          }
        }

        // 스크랩 버튼 클릭 핸들러 수정
        document.querySelectorAll('.scrap-btn-preview').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const postId = this.dataset.postId;
            const postType = this.dataset.postType;
            const scrapsSpan = this.querySelector(`.post-scraps-preview-${postId}`);
            const svg = this.querySelector('svg path');
            
            currentScrapPostId = postId;
            currentScrapPostType = postType;
            
            try {
              const url = postType === 'recruit' 
                ? `/campus/${postId}/scrap`
                : `/campus/seek/${postId}/scrap`;
              
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
              });
              
              const data = await response.json();
              if (data.success) {
                // 숫자와 색상을 항상 함께 업데이트
                scrapsSpan.textContent = data.scraps;
                
                if (data.isScrapped) {
                  // 활성화: 컬러 채우고 숫자 올라감
                  svg.setAttribute('stroke', '#1D5DFF');
                  svg.setAttribute('fill', '#1D5DFF');
                  svg.removeAttribute('fill-opacity');
                  
                  // 스크랩 성공 시 폴더 모달 표시
                  if (folders && folders.length > 0) {
                    showFolderSelectModal();
                  } else {
                    showCreateFolderModal();
                  }
                } else {
                  // 비활성화: fill 비우고 숫자 내려감
                  svg.setAttribute('stroke', '#818181');
                  svg.setAttribute('fill', 'none');
                  svg.removeAttribute('fill-opacity');
                }
              } else {
                console.error('스크랩 처리 실패:', data);
                alert(data.message || '스크랩 처리에 실패했습니다.');
              }
            } catch (error) {
              console.error('스크랩 처리 중 오류:', error);
            }
          });
        });

        // 폴더 생성 폼 제출
        document.getElementById('create-folder-form')?.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const name = formData.get('name');

          if (!name || !name.trim()) {
            alert('폴더 이름을 입력해주세요.');
            return;
          }

          console.log('폴더 생성 시도, currentScrapPostId:', currentScrapPostId, 'currentScrapPostType:', currentScrapPostType);

          try {
            const response = await fetch('/folders', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              credentials: 'same-origin',
              body: JSON.stringify({ name: name.trim() })
            });

            const data = await response.json();
            console.log('폴더 생성 응답:', data);
            
            if (data.success && data.folder) {
              // 폴더 목록에 새 폴더 추가
              folders.push(data.folder);
              console.log('폴더 추가됨, 현재 폴더 목록:', folders);
              
              // 생성된 폴더에 자동으로 글 추가
              if (currentScrapPostId && currentScrapPostType) {
                console.log('글 추가 시도, postId:', currentScrapPostId, 'postType:', currentScrapPostType, 'folderId:', data.folder._id);
                try {
                  const addResponse = await fetch(`/folders/${data.folder._id}/posts`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                      postId: currentScrapPostId,
                      postType: currentScrapPostType
                    })
                  });

                  const addData = await addResponse.json();
                  console.log('폴더에 글 추가 응답:', addData);
                  
                  if (addData.success) {
                    // 폴더 목록 업데이트
                    const folderIndex = folders.findIndex(f => f._id === data.folder._id);
                    if (folderIndex !== -1) {
                      folders[folderIndex] = addData.folder;
                    }
                    
                    document.getElementById('create-folder-modal').close();
                    
                    // 폴더 목록 새로고침
                    updateFolderList();
                    
                    // 폴더 선택 모달로 전환
                    setTimeout(() => {
                      showFolderSelectModal();
                      alert('폴더가 생성되었고 글도 추가되었습니다.');
                    }, 100);
                  } else {
                    document.getElementById('create-folder-modal').close();
                    updateFolderList();
                    setTimeout(() => {
                      showFolderSelectModal();
                      alert('폴더는 생성되었지만 글 추가에 실패했습니다: ' + (addData.message || '알 수 없는 오류'));
                    }, 100);
                  }
                } catch (error) {
                  console.error('폴더에 글 추가 중 오류:', error);
                  document.getElementById('create-folder-modal').close();
                  updateFolderList();
                  setTimeout(() => {
                    showFolderSelectModal();
                    alert('폴더는 생성되었지만 글 추가 중 오류가 발생했습니다: ' + error.message);
                  }, 100);
                }
              } else {
                console.warn('폴더 생성 후 자동 저장 실패: postId 또는 postType이 없음', { currentScrapPostId, currentScrapPostType });
                document.getElementById('create-folder-modal').close();
                updateFolderList();
                setTimeout(() => {
                  showFolderSelectModal();
                  alert('폴더가 생성되었습니다. 글을 추가하려면 폴더를 선택해주세요.');
                }, 100);
              }
            } else {
              alert(data.message || '폴더 생성에 실패했습니다.');
            }
          } catch (error) {
            console.error('폴더 생성 중 오류:', error);
            alert('폴더 생성 중 오류가 발생했습니다.');
          }
        });
      </script>

      <!-- 폴더 선택 모달 -->
      <dialog class="modal" id="folder-select-modal">
        <div class="modal-form">
          <h2>폴더 선택</h2>
          <p class="modal-desc">이 글을 저장할 폴더를 선택하세요</p>
          <div id="folder-list" class="folder-select-list">
            <% if (typeof folders !== 'undefined' && folders && folders.length > 0) { %>
              <% folders.forEach(folder => { %>
                <button type="button" class="folder-select-item" data-folder-id="<%= folder._id %>">
                  <span><%= folder.name %></span>
                  <span class="folder-select-count"><%= folder.posts ? folder.posts.length : 0 %>개</span>
                </button>
              <% }) %>
            <% } else { %>
              <p class="folder-empty-message">폴더가 없습니다. 프로필에서 폴더를 먼저 생성해주세요.</p>
            <% } %>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('folder-select-modal').close(); showCreateFolderModal();">폴더 생성</button>
            <button type="button" class="btn" onclick="document.getElementById('folder-select-modal').close()">취소</button>
          </div>
        </div>
      </dialog>

      <!-- 폴더 생성 모달 -->
      <dialog class="modal" id="create-folder-modal">
        <form id="create-folder-form" class="modal-form" autocomplete="off">
          <h2>폴더 생성</h2>
          <p class="modal-desc">스크랩한 글을 저장할 폴더를 만들어주세요</p>
          <div class="form-group">
            <label for="folder-name">폴더 이름</label>
            <input type="text" id="folder-name" name="name" required autocomplete="off" placeholder="폴더 이름을 입력하세요" />
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">생성</button>
            <button type="button" class="btn" onclick="document.getElementById('create-folder-modal').close()">취소</button>
          </div>
        </form>
      </dialog>
</body>

</html>

