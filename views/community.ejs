<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linker</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/community.css" />
</head>

<body>
  <% const displayName=currentUser && currentUser.nickname ? currentUser.nickname : currentUser && currentUser.name ?
    currentUser.name : "링커" ; %>

    <%- include('include/_nav', { active: 'community', displayName: displayName }) %>

      <main class="main-content" aria-label="메인 콘텐츠">
        <section class="my-board" aria-label="게시판">
          <div class="community-header">
            <div class="board-tabs community-tabs" role="tablist" aria-label="활동 유형">
              <button class="tab-btn is-active" type="button" role="tab" id="tab-all" aria-controls="panel-all"
                aria-selected="true" data-tab="all">전체</button>
              <button class="tab-btn" type="button" role="tab" id="tab-free" aria-controls="panel-free"
                aria-selected="false" data-tab="free">자유게시판</button>
              <button class="tab-btn" type="button" role="tab" id="tab-qna" aria-controls="panel-qna"
                aria-selected="false" data-tab="qna">Q&A</button>
              <button class="tab-btn" type="button" role="tab" id="tab-info" aria-controls="panel-info"
                aria-selected="false" data-tab="info">정보공유</button>
            </div>
            <a href="/community/add" class="community-add-btn">
              + 글 작성하기
            </a>
          </div>

          <div class="board-panels">
            <div class="board-panel is-active" data-panel="all" role="tabpanel" id="panel-all"
              aria-labelledby="tab-all">
              <% if (typeof posts !== 'undefined' && posts && posts.length > 0) { %>
                <% posts.forEach(post => { %>
                  <article class="post-card community-post-card" onclick="window.location.href='/community/<%= post._id %>'">
                    <div class="post-header">
                      <div class="post-header__title community-post-header-title">
                        <div class="community-post-category-wrapper">
                          <span class="community-post-category">
                            <% 
                              const categoryMap = {
                                'free': '자유게시판',
                                'qna': 'Q&A',
                                'info': '정보공유'
                              };
                            %>
                            <%= categoryMap[post.category] || '자유게시판' %>
                          </span>
                        </div>
                        <h2><%= post.title %></h2>
                        <p><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %> · <%= typeof getRelativeTime !== 'undefined' ? getRelativeTime(post.createdAt) : new Date(post.createdAt).toLocaleDateString('ko-KR') %></p>
                      </div>
                      <div class="community-post-actions" onclick="event.stopPropagation();">
                        <button type="button" class="like-btn community-like-btn" data-post-id="<%= post._id %>" data-is-liked="<%= post.isLiked ? 'true' : 'false' %>">
                          <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="<%= post.isLiked ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isLiked ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-likes-<%= post._id %>"><%= post.likes || 0 %></span>
                        </button>
                        <div class="community-comment-count">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
                                  stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
                          </svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <div class="post-body">
                      <p class="community-post-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <article class="post-card post-card--empty community-post-card--empty" aria-live="polite">
                  <div class="post-empty__message">
                    <strong>등록된 글이 없습니다</strong>
                    새로운 커뮤니티 글을 작성하면 순서대로 보여드릴게요.
                  </div>
                </article>
              <% } %>
            </div>

            <div class="board-panel community-board-panel" data-panel="free" role="tabpanel" id="panel-free"
              aria-labelledby="tab-free" hidden>
              <% 
                const freePosts = typeof posts !== 'undefined' && posts ? posts.filter(p => p.category === 'free') : [];
              %>
              <% if (freePosts.length > 0) { %>
                <% freePosts.forEach(post => { %>
                  <article class="post-card community-post-card" onclick="window.location.href='/community/<%= post._id %>'">
                    <div class="post-header">
                      <div class="post-header__title community-post-header-title">
                        <div class="community-post-category-wrapper">
                          <span class="community-post-category">자유게시판</span>
                        </div>
                        <h2><%= post.title %></h2>
                        <p><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %> · <%= typeof getRelativeTime !== 'undefined' ? getRelativeTime(post.createdAt) : new Date(post.createdAt).toLocaleDateString('ko-KR') %></p>
                      </div>
                      <div class="community-post-actions" onclick="event.stopPropagation();">
                        <button type="button" class="like-btn community-like-btn" data-post-id="<%= post._id %>" data-is-liked="<%= post.isLiked ? 'true' : 'false' %>">
                          <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="<%= post.isLiked ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isLiked ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-likes-<%= post._id %>"><%= post.likes || 0 %></span>
                        </button>
                        <div class="community-comment-count">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
                                  stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
                          </svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <div class="post-body">
                      <p class="community-post-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <article class="post-card post-card--empty community-post-card--empty" aria-live="polite">
                  <div class="post-empty__message">
                    <strong>자유게시판 글이 없습니다</strong>
                    자유롭게 이야기를 나눠보세요.
                  </div>
                </article>
              <% } %>
            </div>

            <div class="board-panel" data-panel="qna" role="tabpanel" id="panel-qna"
              aria-labelledby="tab-qna" hidden>
              <% 
                const qnaPosts = typeof posts !== 'undefined' && posts ? posts.filter(p => p.category === 'qna') : [];
              %>
              <% if (qnaPosts.length > 0) { %>
                <% qnaPosts.forEach(post => { %>
                  <article class="post-card community-post-card" onclick="window.location.href='/community/<%= post._id %>'">
                    <div class="post-header">
                      <div class="post-header__title community-post-header-title">
                        <div class="community-post-category-wrapper">
                          <span class="community-post-category">Q&A</span>
                        </div>
                        <h2><%= post.title %></h2>
                        <p><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %> · <%= typeof getRelativeTime !== 'undefined' ? getRelativeTime(post.createdAt) : new Date(post.createdAt).toLocaleDateString('ko-KR') %></p>
                      </div>
                      <div class="community-post-actions" onclick="event.stopPropagation();">
                        <button type="button" class="like-btn community-like-btn" data-post-id="<%= post._id %>" data-is-liked="<%= post.isLiked ? 'true' : 'false' %>">
                          <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="<%= post.isLiked ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isLiked ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-likes-<%= post._id %>"><%= post.likes || 0 %></span>
                        </button>
                        <div class="community-comment-count">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
                                  stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
                          </svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <div class="post-body">
                      <p class="community-post-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <article class="post-card post-card--empty community-post-card--empty" aria-live="polite">
                  <div class="post-empty__message">
                    <strong>Q&A 글이 없습니다</strong>
                    궁금한 점을 질문해보세요.
                  </div>
                </article>
              <% } %>
            </div>

            <div class="board-panel" data-panel="info" role="tabpanel" id="panel-info"
              aria-labelledby="tab-info" hidden>
              <% 
                const infoPosts = typeof posts !== 'undefined' && posts ? posts.filter(p => p.category === 'info') : [];
              %>
              <% if (infoPosts.length > 0) { %>
                <% infoPosts.forEach(post => { %>
                  <article class="post-card community-post-card" onclick="window.location.href='/community/<%= post._id %>'">
                    <div class="post-header">
                      <div class="post-header__title community-post-header-title">
                        <div class="community-post-category-wrapper">
                          <span class="community-post-category">정보공유</span>
                        </div>
                        <h2><%= post.title %></h2>
                        <p><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %> · <%= typeof getRelativeTime !== 'undefined' ? getRelativeTime(post.createdAt) : new Date(post.createdAt).toLocaleDateString('ko-KR') %></p>
                      </div>
                      <div class="community-post-actions" onclick="event.stopPropagation();">
                        <button type="button" class="like-btn community-like-btn" data-post-id="<%= post._id %>" data-is-liked="<%= post.isLiked ? 'true' : 'false' %>">
                          <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="<%= post.isLiked ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isLiked ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-likes-<%= post._id %>"><%= post.likes || 0 %></span>
                        </button>
                        <div class="community-comment-count">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
                                  stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
                          </svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <div class="post-body">
                      <p class="community-post-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                  </article>
                <% }) %>
              <% } else { %>
                <article class="post-card post-card--empty community-post-card--empty" aria-live="polite">
                  <div class="post-empty__message">
                    <strong>정보공유 글이 없습니다</strong>
                    유용한 정보를 공유해보세요.
                  </div>
                </article>
              <% } %>
            </div>
          </div>
        </section>

        <p class="main-footer">Linker와 함께 더 많은 협업 기회를 만들어보세요.</p>
      </main>

      <script>
        (function () {
          const tabButtons = document.querySelectorAll(".tab-btn[role='tab']");
          const panels = document.querySelectorAll("[data-panel]");
          const currentCategory = '<%= typeof currentCategory !== "undefined" ? currentCategory : "all" %>';

          // 현재 카테고리에 맞는 탭 활성화
          if (currentCategory !== 'all') {
            const activeTab = document.querySelector(`[data-tab="${currentCategory}"]`);
            if (activeTab) {
              tabButtons.forEach(btn => {
                btn.classList.remove("is-active");
                btn.setAttribute("aria-selected", "false");
              });
              panels.forEach(panel => {
                panel.classList.remove("is-active");
                panel.hidden = true;
              });
              
              activeTab.classList.add("is-active");
              activeTab.setAttribute("aria-selected", "true");
              const activePanel = document.querySelector(`[data-panel="${currentCategory}"]`);
              if (activePanel) {
                activePanel.classList.add("is-active");
                activePanel.hidden = false;
              }
            }
          }

          tabButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const target = button.dataset.tab;
              
              // 탭 버튼 상태 변경
              tabButtons.forEach((btn) => {
                const isActive = btn === button;
                btn.classList.toggle("is-active", isActive);
                btn.setAttribute("aria-selected", isActive ? "true" : "false");
              });

              // 패널 표시/숨김
              panels.forEach((panel) => {
                const isActive = panel.dataset.panel === target;
                panel.classList.toggle("is-active", isActive);
                panel.hidden = !isActive;
              });
            });
          });

          // 좋아요 기능
          const folders = <%- JSON.stringify(typeof folders !== 'undefined' && folders ? folders : []) %>;
          let currentLikePostId = null;

          function showFolderSelectModal() {
            const modal = document.getElementById('folder-select-modal');
            if (modal) {
              const folderList = document.getElementById('folder-list');
              if (folders && folders.length > 0) {
                folderList.innerHTML = folders.map(folder => `
                  <button type="button" class="folder-select-item" data-folder-id="${folder._id}">
                    <span>${folder.name}</span>
                    <span class="folder-select-count">${folder.posts ? folder.posts.length : 0}개</span>
                  </button>
                `).join('');
                
                document.querySelectorAll('.folder-select-item').forEach(btn => {
                  btn.addEventListener('click', async function() {
                    const folderId = this.dataset.folderId;
                    
                    try {
                      const response = await fetch(`/folders/${folderId}/posts`, {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                          postId: currentLikePostId,
                          postType: 'community'
                        })
                      });

                      const data = await response.json();
                      if (data.success) {
                        document.getElementById('folder-select-modal').close();
                        alert('폴더에 추가되었습니다.');
                      } else {
                        alert(data.message || '폴더에 추가하는데 실패했습니다.');
                      }
                    } catch (error) {
                      console.error('폴더에 추가 중 오류:', error);
                      alert('폴더에 추가 중 오류가 발생했습니다.');
                    }
                  });
                });
              }
              modal.showModal();
            }
          }

          function showCreateFolderModal() {
            const modal = document.getElementById('create-folder-modal');
            if (modal) {
              modal.showModal();
            }
          }

          document.querySelectorAll('.like-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
              e.stopPropagation();
              const postId = this.dataset.postId;
              const likesSpan = this.querySelector(`.post-likes-${postId}`);
              const svg = this.querySelector('svg path');
              
              currentLikePostId = postId;
              
              try {
                const response = await fetch(`/community/${postId}/like`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (data.success) {
                  likesSpan.textContent = data.likes;
                  if (data.isLiked) {
                    svg.setAttribute('stroke', '#1D5DFF');
                    svg.setAttribute('fill', '#1D5DFF');
                    svg.removeAttribute('fill-opacity');
                    
                    // 좋아요 성공 시 폴더 모달 표시
                    if (folders && folders.length > 0) {
                      showFolderSelectModal();
                    } else {
                      showCreateFolderModal();
                    }
                  } else {
                    svg.setAttribute('stroke', '#818181');
                    svg.setAttribute('fill', 'none');
                    svg.removeAttribute('fill-opacity');
                  }
                }
              } catch (error) {
                console.error('좋아요 처리 중 오류:', error);
              }
            });
          });

          // 폴더 생성 폼 제출
          document.getElementById('create-folder-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const name = formData.get('name');

            if (!name || !name.trim()) {
              alert('폴더 이름을 입력해주세요.');
              return;
            }

            try {
              const response = await fetch('/folders', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ name: name.trim() })
              });

              const data = await response.json();
              if (data.success && data.folder) {
                document.getElementById('create-folder-modal').close();
                
                if (currentLikePostId) {
                  try {
                    const addResponse = await fetch(`/folders/${data.folder._id}/posts`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      credentials: 'same-origin',
                      body: JSON.stringify({
                        postId: currentLikePostId,
                        postType: 'community'
                      })
                    });

                    const addData = await addResponse.json();
                    if (addData.success) {
                      alert('폴더가 생성되었고 글도 추가되었습니다.');
                      location.reload();
                    } else {
                      alert('폴더는 생성되었지만 글 추가에 실패했습니다.');
                    }
                  } catch (error) {
                    console.error('폴더에 글 추가 중 오류:', error);
                    alert('폴더는 생성되었지만 글 추가 중 오류가 발생했습니다.');
                  }
                }
              } else {
                alert(data.message || '폴더 생성에 실패했습니다.');
              }
            } catch (error) {
              console.error('폴더 생성 중 오류:', error);
              alert('폴더 생성 중 오류가 발생했습니다.');
            }
          });
        })();
      </script>

      <!-- 폴더 선택 모달 -->
      <dialog class="modal" id="folder-select-modal">
        <div class="modal-form">
          <h2>폴더 선택</h2>
          <p class="modal-desc">이 글을 저장할 폴더를 선택하세요</p>
          <div id="folder-list" class="folder-select-list">
            <% if (typeof folders !== 'undefined' && folders && folders.length > 0) { %>
              <% folders.forEach(folder => { %>
                <button type="button" class="folder-select-item" data-folder-id="<%= folder._id %>">
                  <span><%= folder.name %></span>
                  <span class="folder-select-count"><%= folder.posts ? folder.posts.length : 0 %>개</span>
                </button>
              <% }) %>
            <% } else { %>
              <p class="folder-empty-message">폴더가 없습니다. 프로필에서 폴더를 먼저 생성해주세요.</p>
            <% } %>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('folder-select-modal').close(); showCreateFolderModal();">폴더 생성</button>
            <button type="button" class="btn" onclick="document.getElementById('folder-select-modal').close()">취소</button>
          </div>
        </div>
      </dialog>

      <!-- 폴더 생성 모달 -->
      <dialog class="modal" id="create-folder-modal">
        <form id="create-folder-form" class="modal-form" autocomplete="off">
          <h2>폴더 생성</h2>
          <p class="modal-desc">스크랩한 글을 저장할 폴더를 만들어주세요</p>
          <div class="form-group">
            <label for="folder-name">폴더 이름</label>
            <input type="text" id="folder-name" name="name" required autocomplete="off" placeholder="폴더 이름을 입력하세요" />
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn btn-primary">생성</button>
            <button type="button" class="btn" onclick="document.getElementById('create-folder-modal').close()">취소</button>
          </div>
        </form>
      </dialog>
</body>

</html>

