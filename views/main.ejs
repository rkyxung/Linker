<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linker</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/main.css" />
</head>

<body class="page-home">
  <% const displayName=currentUser && currentUser.nickname ? currentUser.nickname : currentUser && currentUser.name ?
    currentUser.name : "링커" ; %>

    <%- include('include/_nav', { active: 'home', displayName: displayName }) %>

    <main class="main-content" aria-label="메인 콘텐츠">
      <section class="hero-card">
        <div class="hero-text">
          <div class="hero-nickname">
            <span>
              <%= displayName %>님
            </span>
            <a class="hero-edit" href="/profile" aria-label="프로필 편집">
              <svg viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M12.7996 0.725691C12.3738 0.261031 11.7963 0 11.1942 0C10.592 0 10.0145 0.261031 9.5887 0.725691L9.05355 1.31063L12.8004 5.40027L13.3348 4.81615C13.5457 4.58599 13.713 4.31274 13.8271 4.012C13.9413 3.71125 14 3.38892 14 3.06339C14 2.73787 13.9413 2.41553 13.8271 2.11479C13.713 1.81405 13.5457 1.54079 13.3348 1.31063L12.7996 0.725691ZM11.7293 6.5685L7.98249 2.47886L1.10197 9.98975C0.951402 10.1541 0.846221 10.3614 0.798439 10.5879L0.0195548 14.2686C-0.00946676 14.4052 -0.00613785 14.5477 0.0292278 14.6825C0.0645935 14.8174 0.130832 14.9402 0.221701 15.0394C0.31257 15.1385 0.425078 15.2108 0.548624 15.2494C0.67217 15.2881 0.802686 15.2917 0.927874 15.26L4.30077 14.4107C4.50802 14.3584 4.69764 14.2436 4.84803 14.0794L11.7293 6.5685Z"
                  fill="white" fill-opacity="0.8" />
              </svg>

            </a>
          </div>
          <p class="hero-job <%= userDescription && userDescription.role ? '' : 'hero-text--empty' %>">
            <%= userDescription && userDescription.role ? userDescription.role : "직무를 입력해 주세요" %>
          </p>
          <p class="hero-school <%= userDescription && userDescription.school ? '' : 'hero-text--empty' %>">
            <%= userDescription && userDescription.school ? userDescription.school : "소속 정보를 입력해 주세요" %>
        </div>
        <div class="hero-decoration">
          <div class="line-top"></div>
          <div class="dots-top"></div>
          <div class="circleBig-bottom"></div>
        </div>
      </section>

      <section class="my-board" aria-label="게시판">
        <div class="board-tabs" role="tablist" aria-label="활동 유형">
          <button class="tab-btn is-active" type="button" role="tab" id="tab-posted" aria-controls="panel-posted"
            aria-selected="true" data-tab="posted">내가 올린 글</button>
          <button class="tab-btn" type="button" role="tab" id="tab-scrapped" aria-controls="panel-scrapped"
            aria-selected="false" data-tab="scrapped">스크랩한 글</button>
        </div>

        <div class="board-panels">
          <div class="board-panel is-active" data-panel="posted" role="tabpanel" id="panel-posted"
            aria-labelledby="tab-posted">
            <% if (typeof myPosts !== 'undefined' && myPosts && myPosts.length > 0) { %>
              <% 
                const categoryMap = {
                  'free': '자유게시판',
                  'qna': 'Q&A',
                  'info': '정보공유'
                };
              %>
              <% myPosts.forEach(post => { %>
                <article class="post-card" onclick="window.location.href='/community/<%= post._id %>'">
                  <div class="post-card-content-wrapper">
                    <div class="post-card-category-wrapper">
                      <span class="post-card-category">
                        <%= categoryMap[post.category] || '자유게시판' %>
                      </span>
                    </div>
                    <h2 class="post-card-title"><%= post.title %></h2>
                    <p class="post-card-time">
                      <span class="time-ago" data-timestamp="<%= post.createdAt.toISOString() %>"></span>
                    </p>
                    <div class="post-card-body">
                      <p>
                        <%= post.content.length > 80 ? post.content.substring(0, 80) + '...' : post.content %>
                      </p>
                    </div>
                  </div>
                  <div class="post-card-footer" onclick="event.stopPropagation();">
                    <div class="post-card-footer-actions">
                      <button type="button" class="like-btn" data-post-id="<%= post._id %>" data-is-liked="<%= post.isLiked ? 'true' : 'false' %>">
                        <svg width="16" height="15" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="<%= post.isLiked ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isLiked ? '#1D5DFF' : 'none' %>"/>
                        </svg>
                        <span class="post-likes-<%= post._id %>"><%= post.likes || 0 %></span>
                      </button>
                      <div class="post-card-comment">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
</svg>
                        <span><%= post.comments || 0 %></span>
                      </div>
                    </div>
                  </div>
                </article>
              <% }) %>
            <% } else { %>
              <article class="post-card post-card--empty" aria-live="polite">
              <div class="post-empty__message">
                <strong>등록된 글이 없습니다</strong>
                새로운 글을 등록하면 순서대로 보여드릴게요.
              </div>
            </article>
            <% } %>
          </div>

          <div class="board-panel" data-panel="scrapped" role="tabpanel" id="panel-scrapped"
            aria-labelledby="tab-scrapped" hidden>
            <% 
              const renderScrapLabel = (post) => {
                const contestCats = ['design','develop','planning'];
                const isContest = contestCats.includes(post.category);
                if (post.postType === 'recruit') return isContest ? '공모전 · 팀원 모집' : '캠퍼스 · 팀원 모집';
                return isContest ? '공모전 · 팀 구하기' : '캠퍼스 · 팀 구하기';
              };
              const scrapUrl = (post) => {
                const contestCats = ['design','develop','planning'];
                const isContest = contestCats.includes(post.category);
                if (post.postType === 'recruit') return isContest ? `/contest/${post._id}` : `/campus/${post._id}`;
                return isContest ? `/contest/seek/${post._id}` : `/campus/seek/${post._id}`;
              };
            %>
            <% if (typeof scrappedPosts !== 'undefined' && scrappedPosts && scrappedPosts.length > 0) { %>
              <% scrappedPosts.forEach(post => { %>
                <article class="post-card" onclick="window.location.href='<%= scrapUrl(post) %>'">
                  <div class="post-card-content-wrapper">
                    <div class="post-card-category-wrapper">
                      <span class="post-card-category">
                        <%= renderScrapLabel(post) %>
                      </span>
                    </div>
                    <h2 class="post-card-title post-card-title--no-padding"><%= post.title %></h2>
                    <p class="post-card-time post-card-time--no-padding">
                      <span class="time-ago" data-timestamp="<%= post.createdAt.toISOString() %>"></span>
                    </p>
                    <div class="post-card-body post-card-body--no-padding">
                      <p>
                        <%= post.content && post.content.length > 80 ? post.content.substring(0, 80) + '...' : (post.content || '') %>
                      </p>
                    </div>
                  </div>
                  <div class="post-card-footer" onclick="event.stopPropagation();">
                    <div class="post-card-footer-actions">
                      <div class="post-card-scrap">
                        <svg width="14" height="17" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M13.7139 1C14.0837 1 14.3718 1.1174 14.6318 1.37012C14.891 1.62205 15.0004 1.88812 15 2.2207V18.5L8.38477 15.7432C8.13863 15.6406 7.86137 15.6406 7.61523 15.7432L1 18.5V2.22266C1 1.88855 1.10965 1.6221 1.36816 1.37109C1.59622 1.14975 1.84572 1.03206 2.15234 1.00586L2.28711 1H13.7139Z" stroke="#1D5DFF" stroke-width="2" stroke-linejoin="round" fill="#1D5DFF"/>
                        </svg>
                        <span><%= post.scraps || 0 %></span>
                      </div>
                        <div class="post-card-comment">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
</svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                  </article>
                <% }) %>
            <% } else { %>
              <article class="post-card post-card--empty" aria-live="polite">
                <div class="post-empty__message">
                  <strong>스크랩한 글이 없습니다</strong>
                  관심있는 글을 스크랩하면 이곳에 표시됩니다.
                </div>
              </article>
            <% } %>
          </div>
        </div>
      </section>

      <section class="popularity-board" aria-label="인기글">
        <div class="popularity-header">
          <h2>인기글</h2>
          <div class="chip-group" role="tablist" aria-label="인기글 유형">
            <button class="chip chip--active" type="button" role="tab" aria-selected="true"
              data-trend="campus">캠퍼스</button>
            <button class="chip" type="button" role="tab" aria-selected="false" data-trend="contest">공모전</button>
          </div>
        </div>

        <div class="trend-panels">
          <div class="trend-panel is-active" data-trend-panel="campus">
            <% if (typeof popularCampus !== 'undefined' && popularCampus && popularCampus.length > 0) { %>
              <div class="trend-panel-grid">
                <% popularCampus.forEach(post => { %>
                  <article class="post-card" onclick="window.location.href='<%= post.postType === 'recruit' ? '/campus/' : '/campus/seek/' %><%= post._id %>'">
                    <!-- 상단: 제목 + 스크랩/댓글 -->
                    <div class="post-card-header">
                      <h2 class="post-card-title"><%= post.title %></h2>
                      <div class="post-card-actions" onclick="event.stopPropagation();">
                        <button type="button" class="scrap-btn-preview" data-post-id="<%= post._id %>" data-post-type="<%= post.postType %>" data-is-scrapped="<%= post.isScrapped ? 'true' : 'false' %>">
                          <svg width="14" height="17" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.7139 1C14.0837 1 14.3718 1.1174 14.6318 1.37012C14.891 1.62205 15.0004 1.88812 15 2.2207V18.5L8.38477 15.7432C8.13863 15.6406 7.86137 15.6406 7.61523 15.7432L1 18.5V2.22266C1 1.88855 1.10965 1.6221 1.36816 1.37109C1.59622 1.14975 1.84572 1.03206 2.15234 1.00586L2.28711 1H13.7139Z" stroke="<%= post.isScrapped ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isScrapped ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-scraps-preview-<%= post._id %>"><%= post.scraps || 0 %></span>
                        </button>
                        <div class="post-card-comment">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
</svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <!-- 본문: 내용 -->
                    <div class="post-card-body">
                      <p class="post-card-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                    <!-- 해시태그 -->
                    <% if (post.hashtags && post.hashtags.length > 0) { %>
                      <div class="post-card-hashtags">
                        <% post.hashtags.forEach(tag => { %>
                          <span class="post-card-hashtag">#<%= tag %></span>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="post-card-hashtags-empty"></div>
                    <% } %>
                    <!-- 하단: 글쓴이 + 마감일 -->
                    <div class="post-card-footer">
                      <span><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %></span>
                      <span>마감일: <%= post.postType === 'recruit' && post.deadline ? new Date(post.deadline).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\./g, '.').replace(/\s/g, '') : '-' %></span>
                    </div>
                  </article>
                <% }) %>
              </div>
            <% } else { %>
              <article class="post-card post-card--empty" aria-live="polite">
                <div class="post-empty__message">
                  <strong>등록된 글이 없습니다</strong>
                  인기 캠퍼스 글이 있으면 이곳에 표시됩니다.
                </div>
              </article>
            <% } %>
          </div>

          <div class="trend-panel" data-trend-panel="contest" hidden>
            <% if (typeof popularContest !== 'undefined' && popularContest && popularContest.length > 0) { %>
              <div class="trend-panel-grid">
                <% popularContest.forEach(post => { %>
                  <article class="post-card" onclick="window.location.href='<%= post.postType === 'recruit' ? '/contest/' : '/contest/seek/' %><%= post._id %>'">
                    <!-- 상단: 제목 + 스크랩/댓글 -->
                    <div class="post-card-header">
                      <h2 class="post-card-title"><%= post.title %></h2>
                      <div class="post-card-actions" onclick="event.stopPropagation();">
                        <button type="button" class="scrap-btn-preview" data-post-id="<%= post._id %>" data-post-type="<%= post.postType %>" data-is-scrapped="<%= post.isScrapped ? 'true' : 'false' %>">
                          <svg width="14" height="17" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.7139 1C14.0837 1 14.3718 1.1174 14.6318 1.37012C14.891 1.62205 15.0004 1.88812 15 2.2207V18.5L8.38477 15.7432C8.13863 15.6406 7.86137 15.6406 7.61523 15.7432L1 18.5V2.22266C1 1.88855 1.10965 1.6221 1.36816 1.37109C1.59622 1.14975 1.84572 1.03206 2.15234 1.00586L2.28711 1H13.7139Z" stroke="<%= post.isScrapped ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= post.isScrapped ? '#1D5DFF' : 'none' %>"/>
                          </svg>
                          <span class="post-scraps-preview-<%= post._id %>"><%= post.scraps || 0 %></span>
                        </button>
                        <div class="post-card-comment">
                          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
</svg>
                          <span><%= post.comments || 0 %></span>
                        </div>
                      </div>
                    </div>
                    <!-- 본문: 내용 -->
                    <div class="post-card-body">
                      <p class="post-card-content">
                        <%= post.content.length > 100 ? post.content.substring(0, 100) + '...' : post.content %>
                      </p>
                    </div>
                    <!-- 해시태그 -->
                    <% if (post.hashtags && post.hashtags.length > 0) { %>
                      <div class="post-card-hashtags">
                        <% post.hashtags.forEach(tag => { %>
                          <span class="post-card-hashtag">#<%= tag %></span>
                        <% }) %>
                      </div>
                    <% } else { %>
                      <div class="post-card-hashtags-empty"></div>
                    <% } %>
                    <!-- 하단: 글쓴이 + 마감일 -->
                    <div class="post-card-footer">
                      <span><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %></span>
                      <span>마감일: <%= post.postType === 'recruit' && post.deadline ? new Date(post.deadline).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\./g, '.').replace(/\s/g, '') : '-' %></span>
                    </div>
                  </article>
                <% }) %>
              </div>
            <% } else { %>
              <article class="post-card post-card--empty" aria-live="polite">
                <div class="post-empty__message">
                  <strong>등록된 글이 없습니다</strong>
                  인기 공모전 글이 있으면 이곳에 표시됩니다.
                </div>
              </article>
            <% } %>
          </div>
        </div>
      </section>

      <p class="main-footer">Linker와 함께 더 많은 협업 기회를 만들어보세요.</p>
    </main>

    <!-- 폴더 선택 모달 -->
    <dialog class="modal" id="folder-select-modal">
      <div class="modal-form">
        <h2>폴더 선택</h2>
        <p class="modal-desc">이 글을 저장할 폴더를 선택하세요</p>
        <div id="folder-list" class="folder-select-list">
          <% if (typeof folders !== 'undefined' && folders && folders.length > 0) { %>
            <% folders.forEach(folder => { %>
              <button type="button" class="folder-select-item" data-folder-id="<%= folder._id %>">
                <span><%= folder.name %></span>
                <span class="folder-select-count"><%= folder.posts ? folder.posts.length : 0 %>개</span>
              </button>
            <% }) %>
          <% } else { %>
            <p class="folder-empty-message">폴더가 없습니다. 프로필에서 폴더를 먼저 생성해주세요.</p>
          <% } %>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-primary" onclick="document.getElementById('folder-select-modal').close(); showCreateFolderModal();">폴더 생성</button>
          <button type="button" class="btn" onclick="document.getElementById('folder-select-modal').close()">취소</button>
        </div>
      </div>
    </dialog>

    <!-- 폴더 생성 모달 -->
    <dialog class="modal" id="create-folder-modal">
      <form id="create-folder-form" class="modal-form" autocomplete="off">
        <h2>폴더 생성</h2>
        <p class="modal-desc">스크랩한 글을 저장할 폴더를 만들어주세요</p>
        <div class="form-group">
          <label for="folder-name">폴더 이름</label>
          <input type="text" id="folder-name" name="name" required autocomplete="off" placeholder="폴더 이름을 입력하세요" />
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">생성</button>
          <button type="button" class="btn" onclick="document.getElementById('create-folder-modal').close()">취소</button>
        </div>
      </form>
    </dialog>

    <script>
      (function () {
        const tabButtons = document.querySelectorAll(".tab-btn[role='tab']");
        const panels = document.querySelectorAll("[data-panel]");
        const trendChips = document.querySelectorAll(".chip-group .chip[role='tab']");
        const trendPanels = document.querySelectorAll("[data-trend-panel]");

        tabButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const target = button.dataset.tab;

            tabButtons.forEach((btn) => {
              const isActive = btn === button;
              btn.classList.toggle("is-active", isActive);
              btn.setAttribute("aria-selected", isActive ? "true" : "false");
            });

            panels.forEach((panel) => {
              const isActive = panel.dataset.panel === target;
              panel.classList.toggle("is-active", isActive);
              panel.hidden = !isActive;
            });
          });
        });

        // 인기글 탭 클릭 이벤트
        trendChips.forEach((button) => {
          button.addEventListener("click", () => {
            const trend = button.dataset.trend;
            
            // 모든 탭의 활성 상태 변경
            trendChips.forEach((btn) => {
              const isActive = btn === button;
              btn.classList.toggle("chip--active", isActive);
              btn.setAttribute("aria-selected", isActive ? "true" : "false");
            });

            trendPanels.forEach(panel => {
              const isActive = panel.dataset.trendPanel === trend;
              panel.classList.toggle("is-active", isActive);
              panel.hidden = !isActive;
            });
          });
        });

        // 상대 시간 표시 함수
        function timeAgo(date) {
          const seconds = Math.floor((new Date() - new Date(date)) / 1000);
          let interval = seconds / 31536000;
          if (interval > 1) return Math.floor(interval) + "년 전";
          interval = seconds / 2592000;
          if (interval > 1) return Math.floor(interval) + "개월 전";
          interval = seconds / 86400;
          if (interval > 1) return Math.floor(interval) + "일 전";
          interval = seconds / 3600;
          if (interval > 1) return Math.floor(interval) + "시간 전";
          interval = seconds / 60;
          if (interval > 1) return Math.floor(interval) + "분 전";
          return Math.floor(seconds) + "초 전";
        }

        // 상대 시간 업데이트
        document.querySelectorAll('.time-ago').forEach(element => {
          const timestamp = element.dataset.timestamp;
          if (timestamp) {
            element.textContent = timeAgo(timestamp);
          }
        });

        // 폴더 모달 관련 변수
        let folders = <%- JSON.stringify(typeof folders !== 'undefined' && folders ? folders : []) %>;
        let currentLikePostId = null;
        let currentScrapPostId = null;
        let currentScrapPostType = null;
        let currentActionType = null; // 'like' or 'scrap'

        // 폴더 목록 업데이트 함수
        function updateFolderList() {
          const folderList = document.getElementById('folder-list');
          if (folders && folders.length > 0) {
            folderList.innerHTML = folders.map(folder => `
              <button type="button" class="folder-select-item" data-folder-id="${folder._id}">
                <span>${folder.name}</span>
                <span class="folder-select-count">${folder.posts ? folder.posts.length : 0}개</span>
              </button>
            `).join('');
            
            // 폴더 선택 이벤트 리스너 추가
            document.querySelectorAll('.folder-select-item').forEach(btn => {
              btn.addEventListener('click', async function() {
                const folderId = this.dataset.folderId;
                
                try {
                  const postId = currentActionType === 'like' ? currentLikePostId : currentScrapPostId;
                  const postType = currentActionType === 'like' ? 'community' : currentScrapPostType;
                  
                  const response = await fetch(`/folders/${folderId}/posts`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                      postId: postId,
                      postType: postType
                    })
                  });

                  const data = await response.json();
                  if (data.success) {
                    // 폴더 목록 업데이트
                    const folderIndex = folders.findIndex(f => f._id === folderId);
                    if (folderIndex !== -1) {
                      folders[folderIndex] = data.folder;
                      updateFolderList();
                    }
                    document.getElementById('folder-select-modal').close();
                    alert('폴더에 추가되었습니다.');
                  } else {
                    alert(data.message || '폴더에 추가하는데 실패했습니다.');
                  }
                } catch (error) {
                  console.error('폴더에 추가 중 오류:', error);
                  alert('폴더에 추가 중 오류가 발생했습니다.');
                }
              });
            });
          } else {
            folderList.innerHTML = '<p class="folder-empty-message">폴더가 없습니다. 프로필에서 폴더를 먼저 생성해주세요.</p>';
          }
        }

        // 폴더 모달 함수 정의 (좋아요 핸들러보다 먼저 정의)
        function showFolderSelectModal() {
          const modal = document.getElementById('folder-select-modal');
          if (modal) {
            updateFolderList();
            modal.showModal();
          }
        }

        function showCreateFolderModal() {
          const modal = document.getElementById('create-folder-modal');
          if (modal) {
            console.log('폴더 생성 모달 표시:', { 
              currentActionType, 
              currentLikePostId, 
              currentScrapPostId, 
              currentScrapPostType 
            });
            modal.showModal();
          }
        }

        // 좋아요 기능
        document.querySelectorAll('.like-btn').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const postId = this.dataset.postId;
            const likesSpan = this.querySelector(`.post-likes-${postId}`);
            const svg = this.querySelector('svg path');
            
            currentLikePostId = postId;
            currentActionType = 'like';
            
            try {
              const response = await fetch(`/community/${postId}/like`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
              });
              
              const data = await response.json();
              if (data.success) {
                likesSpan.textContent = data.likes;
                if (svg) {
                  if (data.isLiked) {
                    svg.setAttribute('stroke', '#1D5DFF');
                    svg.setAttribute('fill', '#1D5DFF');
                    svg.removeAttribute('fill-opacity');
                    
                    // 좋아요 성공 시 폴더 모달 표시
                    console.log('좋아요 성공, 폴더 모달 표시:', { 
                      currentActionType, 
                      currentLikePostId, 
                      foldersLength: folders ? folders.length : 0 
                    });
                    if (folders && folders.length > 0) {
                      showFolderSelectModal();
                    } else {
                      showCreateFolderModal();
                    }
                  } else {
                    svg.setAttribute('stroke', '#818181');
                    svg.setAttribute('fill', 'none');
                    svg.removeAttribute('fill-opacity');
                  }
                }
              }
            } catch (error) {
              console.error('좋아요 처리 중 오류:', error);
            }
          });
        });

        // 스크랩 버튼 클릭 핸들러
        document.querySelectorAll('.scrap-btn-preview').forEach(btn => {
          btn.addEventListener('click', async function(e) {
            e.stopPropagation();
            const postId = this.dataset.postId;
            const postType = this.dataset.postType;
            const scrapsSpan = this.querySelector(`.post-scraps-preview-${postId}`);
            const svg = this.querySelector('svg path');
            
            currentScrapPostId = postId;
            currentScrapPostType = postType;
            currentActionType = 'scrap';
            
            try {
              const url = postType === 'recruit' 
                ? `/campus/${postId}/scrap`
                : `/campus/seek/${postId}/scrap`;
              
              const response = await fetch(url, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                credentials: 'same-origin'
              });
              
              const data = await response.json();
              if (data.success) {
                scrapsSpan.textContent = data.scraps;
                if (data.isScrapped) {
                  svg.setAttribute('stroke', '#1D5DFF');
                  svg.setAttribute('fill', '#1D5DFF');
                  svg.removeAttribute('fill-opacity');
                  
                  // 스크랩 성공 시 폴더 모달 표시
                  if (folders && folders.length > 0) {
                    showFolderSelectModal();
                  } else {
                    showCreateFolderModal();
                  }
                } else {
                  svg.setAttribute('stroke', '#818181');
                  svg.setAttribute('fill', 'none');
                  svg.removeAttribute('fill-opacity');
                }
              }
            } catch (error) {
              console.error('스크랩 처리 중 오류:', error);
            }
          });
        });

        // 폴더 생성 폼 제출
        document.getElementById('create-folder-form')?.addEventListener('submit', async function(e) {
          e.preventDefault();
          const formData = new FormData(this);
          const name = formData.get('name');

          if (!name || !name.trim()) {
            alert('폴더 이름을 입력해주세요.');
            return;
          }

          try {
            const response = await fetch('/folders', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              credentials: 'same-origin',
              body: JSON.stringify({ name: name.trim() })
            });

            const data = await response.json();
            if (data.success && data.folder) {
              // 폴더 목록에 새 폴더 추가
              folders.push(data.folder);
              
              // 생성된 폴더에 자동으로 글 추가
              const postId = currentActionType === 'like' ? currentLikePostId : currentScrapPostId;
              const postType = currentActionType === 'like' ? 'community' : currentScrapPostType;
              
              console.log('폴더 생성 후 자동 저장:', { 
                currentActionType, 
                postId, 
                postType, 
                currentLikePostId, 
                currentScrapPostId, 
                currentScrapPostType 
              });
              
              if (postId && postType) {
                try {
                  const addResponse = await fetch(`/folders/${data.folder._id}/posts`, {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                      postId: postId,
                      postType: postType
                    })
                  });

                  const addData = await addResponse.json();
                  console.log('폴더에 글 추가 응답:', addData);
                  if (addData.success) {
                    // 폴더 목록 업데이트
                    const folderIndex = folders.findIndex(f => f._id === data.folder._id);
                    if (folderIndex !== -1) {
                      folders[folderIndex] = addData.folder;
                    }
                    
                    document.getElementById('create-folder-modal').close();
                    
                    // 폴더 선택 모달로 전환
                    showFolderSelectModal();
                    alert('폴더가 생성되었고 글도 추가되었습니다.');
                  } else {
                    document.getElementById('create-folder-modal').close();
                    alert('폴더는 생성되었지만 글 추가에 실패했습니다: ' + (addData.message || '알 수 없는 오류'));
                  }
                } catch (error) {
                  console.error('폴더에 글 추가 중 오류:', error);
                  document.getElementById('create-folder-modal').close();
                  alert('폴더는 생성되었지만 글 추가 중 오류가 발생했습니다: ' + error.message);
                }
              } else {
                console.warn('폴더 생성 후 자동 저장 실패: postId 또는 postType이 없음', { postId, postType });
                document.getElementById('create-folder-modal').close();
                // 폴더만 생성된 경우 폴더 선택 모달로 전환
                showFolderSelectModal();
              }
            } else {
              alert(data.message || '폴더 생성에 실패했습니다.');
            }
          } catch (error) {
            console.error('폴더 생성 중 오류:', error);
            alert('폴더 생성 중 오류가 발생했습니다.');
          }
        });
      })();
    </script>
</body>

</html>