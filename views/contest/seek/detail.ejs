<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linker</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/detail.css" />
</head>

<body class="page-contest">
  <% const displayName=currentUser && currentUser.nickname ? currentUser.nickname : currentUser && currentUser.name ?
    currentUser.name : "링커" ; %>

    <%- include('../../include/_nav', { active: 'contest', displayName: displayName }) %>

      <main class="main-content" aria-label="메인 콘텐츠">
        <div class="post-detail-container">
          <a href="/contest" class="back-link">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            목록으로
          </a>

          <div class="post-header">
            <div class="post-header-left">
              <span class="post-category"><%= post.category === 'design' ? '디자인' : post.category === 'develop' ? '개발' : '기획' %></span>
              <h1 class="post-title"><%= post.title %></h1>
              <div class="post-meta">
                <span><%= post.writer && post.writer.nickname ? post.writer.nickname : post.writer && post.writer.name ? post.writer.name : '익명' %></span>
                <span>·</span>
                <span><%= new Date(post.createdAt).toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %></span>
              </div>
            </div>
            <div class="post-stats">
              <button type="button" class="post-stat-item post-stat-item-btn scrap-btn-detail" data-post-id="<%= post._id %>" data-post-type="seeking" data-is-scrapped="<%= isScrapped ? 'true' : 'false' %>">
                <svg width="16" height="20" viewBox="0 0 16 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M13.7139 1C14.0837 1 14.3718 1.1174 14.6318 1.37012C14.891 1.62205 15.0004 1.88812 15 2.2207V18.5L8.38477 15.7432C8.13863 15.6406 7.86137 15.6406 7.61523 15.7432L1 18.5V2.22266C1 1.88855 1.10965 1.6221 1.36816 1.37109C1.59622 1.14975 1.84572 1.03206 2.15234 1.00586L2.28711 1H13.7139Z" stroke="<%= typeof isScrapped !== 'undefined' && isScrapped ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= typeof isScrapped !== 'undefined' && isScrapped ? '#1D5DFF' : 'none' %>"/>
                </svg>
                <span class="post-scraps-detail-<%= post._id %>"><%= post.scraps || 0 %></span>
              </button>
              <div class="post-stat-item">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 4c4.418 0 8 2.91 8 6.5 0 1.3-.42 2.53-1.17 3.58l0.85 4.18-3.86-1.1C14.7 17.86 13.38 18 12 18c-4.418 0-8-2.91-8-6.5S7.582 4 12 4Z"
                        stroke="#818181" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
                </svg>
                <span class="post-comments-count"><%= post.comments || 0 %></span>
              </div>
              <% if (typeof isOwner !== 'undefined' && isOwner) { %>
                <div class="more-menu-wrapper">
                  <button type="button" class="more-menu-btn post-more-btn" data-post-id="<%= post._id %>">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="12" cy="5" r="2" fill="currentColor"/>
                      <circle cx="12" cy="12" r="2" fill="currentColor"/>
                      <circle cx="12" cy="19" r="2" fill="currentColor"/>
                    </svg>
                  </button>
                  <div class="more-menu post-more-menu" data-post-id="<%= post._id %>">
                    <button type="button" class="more-menu-item" onclick="window.location.href='/contest/seek/<%= post._id %>/edit'">수정하기</button>
                    <button type="button" class="more-menu-item danger" onclick="deletePost('<%= post._id %>')">삭제하기</button>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <div class="post-content">
            <%= post.content || '' %>
          </div>

          <% if (post.hashtags && post.hashtags.length > 0) { %>
            <div class="hashtags">
              <% post.hashtags.forEach(tag => { %>
                <span class="hashtag">#<%= tag %></span>
              <% }) %>
            </div>
          <% } %>

          <div class="comments-section">
            <h2 class="comments-title">댓글</h2>
            
            <div class="comment-form">
              <textarea class="comment-input" id="comment-input" placeholder="댓글을 입력하세요..." rows="3"></textarea>
              <button type="button" class="comment-submit" id="comment-submit">댓글 작성</button>
            </div>

            <div class="comment-list" id="comment-list">
              <% if (typeof comments !== 'undefined' && comments && comments.length > 0) { %>
                <% comments.forEach(comment => { %>
                  <div class="comment-item" data-comment-id="<%= comment._id %>">
                    <div class="comment-header">
                      <div>
                        <span class="comment-author"><%= comment.writer && comment.writer.nickname ? comment.writer.nickname : comment.writer && comment.writer.name ? comment.writer.name : '익명' %></span>
                        <span class="comment-date comment-time-ago" data-timestamp="<%= comment.createdAt.toISOString() %>"> · </span>
                      </div>
                      <% if (typeof comment.isCommentOwner !== 'undefined' && comment.isCommentOwner) { %>
                        <div class="more-menu-wrapper">
                          <button type="button" class="more-menu-btn comment-more-btn" data-comment-id="<%= comment._id %>">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <circle cx="12" cy="5" r="2" fill="currentColor"/>
                              <circle cx="12" cy="12" r="2" fill="currentColor"/>
                              <circle cx="12" cy="19" r="2" fill="currentColor"/>
                            </svg>
                          </button>
                          <div class="more-menu comment-more-menu" data-comment-id="<%= comment._id %>">
                            <button type="button" class="more-menu-item" onclick="editComment('<%= comment._id %>', '<%= comment.content.replace(/'/g, "\\'") %>')">수정하기</button>
                            <button type="button" class="more-menu-item danger" onclick="deleteComment('<%= comment._id %>')">삭제하기</button>
                          </div>
                        </div>
                      <% } %>
                    </div>
                    <div class="comment-content"><%= comment.content %></div>
                    <div class="comment-actions">
                      <button type="button" class="comment-like-btn" data-comment-id="<%= comment._id %>">
                        <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="<%= typeof comment.isLiked !== 'undefined' && comment.isLiked ? '#1D5DFF' : '#818181' %>" stroke-width="2" stroke-linejoin="round" fill="<%= typeof comment.isLiked !== 'undefined' && comment.isLiked ? '#1D5DFF' : 'none' %>"/>
                        </svg>
                        <span class="comment-likes-<%= comment._id %>"><%= comment.likes || 0 %></span>
                      </button>
                    </div>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="comment-empty-message">아직 댓글이 없습니다. 첫 댓글을 작성해보세요!</p>
              <% } %>
            </div>
          </div>
        </div>

        <!-- 폴더 선택 모달 -->
        <dialog class="modal" id="folder-select-modal">
          <div class="modal-form">
            <h2>폴더 선택</h2>
            <p class="modal-desc">이 글을 저장할 폴더를 선택하세요</p>
            <div id="folder-list" class="folder-select-list">
              <% if (typeof folders !== 'undefined' && folders && folders.length > 0) { %>
                <% folders.forEach(folder => { %>
                  <button type="button" class="folder-select-item" data-folder-id="<%= folder._id %>">
                    <span><%= folder.name %></span>
                    <span class="folder-select-count"><%= folder.posts ? folder.posts.length : 0 %>개</span>
                  </button>
                <% }) %>
              <% } else { %>
                <p class="folder-empty-message">폴더가 없습니다. 프로필에서 폴더를 먼저 생성해주세요.</p>
              <% } %>
            </div>
            <div class="modal-actions">
              <button type="button" class="btn btn-primary" onclick="document.getElementById('folder-select-modal').close(); showCreateFolderModal();">폴더 생성</button>
              <button type="button" class="btn" onclick="document.getElementById('folder-select-modal').close()">취소</button>
            </div>
          </div>
        </dialog>

        <!-- 폴더 생성 모달 -->
        <dialog class="modal" id="create-folder-modal">
          <div class="modal-form">
            <h2>새 폴더 만들기</h2>
            <p class="modal-desc">저장할 폴더 이름을 입력하세요</p>
            <div class="form-group">
              <label for="folder-name-input">폴더 이름</label>
              <input type="text" id="folder-name-input" placeholder="예: 디자인 영감" />
            </div>
            <div class="modal-actions">
              <button type="button" class="btn btn-primary" onclick="createFolder()">생성</button>
              <button type="button" class="btn" onclick="document.getElementById('create-folder-modal').close()">취소</button>
            </div>
          </div>
        </dialog>

      </main>

      <script>
        // 상대 시간 표시
        function commentTimeAgo(date) {
          const commentDate = new Date(date);
          const now = new Date();
          const diff = now - commentDate;
          const seconds = Math.floor(diff / 1000);
          const minutes = Math.floor(seconds / 60);
          const hours = Math.floor(minutes / 60);
          const days = Math.floor(hours / 24);

          if (seconds < 60) return "방금 전";
          if (minutes < 60) return `${minutes}분 전`;
          if (hours < 24) return `${hours}시간 전`;
          if (days < 7) return `${days}일 전`;
          return commentDate.toLocaleDateString('ko-KR');
        }

        document.querySelectorAll('.comment-time-ago').forEach(element => {
          const timestamp = element.dataset.timestamp;
          if (timestamp) {
            element.textContent = ` · ${commentTimeAgo(timestamp)}`;
          }
        });

        // 댓글 작성
        document.getElementById('comment-submit')?.addEventListener('click', async function() {
          const input = document.getElementById('comment-input');
          const content = input.value.trim();
          if (!content) {
            alert('댓글 내용을 입력해주세요.');
            return;
          }

          const postId = "<%= post._id %>";

          try {
            const response = await fetch(`/contest/seek/${postId}/comment`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ content }),
            });

            const data = await response.json();
            if (!data.success) {
              alert(data.message || '댓글 작성에 실패했습니다.');
              return;
            }

            const commentList = document.getElementById('comment-list');
            const emptyMsg = commentList.querySelector('p');
            if (emptyMsg) emptyMsg.remove();

            const escapedContent = data.comment.content.replace(/'/g, "\\'").replace(/\n/g, '\\n');
            const commentHtml = `
              <div class="comment-item" data-comment-id="${data.comment._id}">
                <div class="comment-header">
                  <div>
                    <span class="comment-author">${data.comment.writer && data.comment.writer.nickname ? data.comment.writer.nickname : data.comment.writer && data.comment.writer.name ? data.comment.writer.name : '익명'}</span>
                    <span class="comment-date comment-time-ago" data-timestamp="${data.comment.createdAt}"> · 방금 전</span>
                  </div>
                  <div class="more-menu-wrapper">
                    <button type="button" class="more-menu-btn comment-more-btn" data-comment-id="${data.comment._id}">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="5" r="2" fill="currentColor"/>
                        <circle cx="12" cy="12" r="2" fill="currentColor"/>
                        <circle cx="12" cy="19" r="2" fill="currentColor"/>
                      </svg>
                    </button>
                    <div class="more-menu comment-more-menu" data-comment-id="${data.comment._id}">
                      <button type="button" class="more-menu-item" onclick="editComment('${data.comment._id}', '${escapedContent}')">수정하기</button>
                      <button type="button" class="more-menu-item danger" onclick="deleteComment('${data.comment._id}')">삭제하기</button>
                    </div>
                  </div>
                </div>
                <div class="comment-content">${data.comment.content}</div>
                <div class="comment-actions">
                  <button type="button" class="comment-like-btn" data-comment-id="${data.comment._id}">
                    <svg width="20" height="19" viewBox="0 0 20 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14.5 1C17.0289 1 19 2.96348 19 5.5C19 7.05624 18.3069 8.55147 16.8818 10.2949C15.4458 12.0517 13.3728 13.9364 10.7783 16.2891L10.7764 16.29L10 16.9971L9.22363 16.29L9.22168 16.2891C6.62719 13.9364 4.55418 12.0517 3.11816 10.2949C1.69311 8.55147 1 7.05624 1 5.5C1 2.96348 2.97109 1 5.5 1C6.9377 1 8.33417 1.67462 9.24121 2.73145C9.43119 2.95272 9.70835 3.08008 10 3.08008C10.2916 3.08008 10.5688 2.95272 10.7588 2.73145C11.6658 1.67462 13.0623 1 14.5 1Z" stroke="#818181" stroke-width="2" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span class="comment-likes-${data.comment._id}">0</span>
                  </button>
                </div>
              </div>
            `;

            commentList.insertAdjacentHTML('beforeend', commentHtml);
            input.value = '';

            const commentCount = document.querySelector('.post-comments-count');
            if (commentCount) {
              commentCount.textContent = data.commentCount;
            }
          } catch (error) {
            console.error(error);
            alert('댓글 작성 중 오류가 발생했습니다.');
          }
        });

        // 스크랩 토글
        document.querySelector('.scrap-btn-detail')?.addEventListener('click', async function(event) {
          event.stopPropagation();
          const postId = this.dataset.postId;
          try {
            const response = await fetch(`/contest/seek/${postId}/scrap`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (!data.success) {
              alert(data.message || '스크랩 처리 중 오류가 발생했습니다.');
              return;
            }
            const svgPath = this.querySelector('path');
            if (svgPath) {
              svgPath.setAttribute('stroke', data.isScrapped ? '#1D5DFF' : '#818181');
              svgPath.setAttribute('fill', data.isScrapped ? '#1D5DFF' : 'none');
            }
            const countSpan = document.querySelector(`.post-scraps-detail-${postId}`);
            if (countSpan) countSpan.textContent = data.scraps;
          } catch (error) {
            console.error(error);
            alert('스크랩 처리 중 오류가 발생했습니다.');
          }
        });

        // 더보기 메뉴 (점 세 개)
        function setupMoreMenu(btn) {
          if (!btn) return;
          if (btn.dataset.attached === 'true') return;
          btn.dataset.attached = 'true';

          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = this.nextElementSibling;
            document.querySelectorAll('.more-menu').forEach(m => {
              if (m !== menu) m.classList.remove('show');
            });
            menu.classList.toggle('show');
          });
        }

        document.querySelectorAll('.more-menu-btn').forEach(btn => setupMoreMenu(btn));
        document.addEventListener('click', () => {
          document.querySelectorAll('.more-menu').forEach(m => m.classList.remove('show'));
        });

        function deletePost(postId) {
          if (!confirm('정말 글을 삭제하시겠습니까?')) return;
          fetch(`/contest/seek/${postId}?_method=DELETE`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          }).then(res => res.json())
            .then(data => {
              if (data.success) {
                alert('글이 삭제되었습니다.');
                window.location.href = '/contest';
              } else {
                alert(data.message || '삭제에 실패했습니다.');
              }
            }).catch(err => {
              console.error(err);
              alert('삭제 중 오류가 발생했습니다.');
            });
        }
      </script>
      <script src="/js/passwordToggle.js"></script>
</body>
</html>
